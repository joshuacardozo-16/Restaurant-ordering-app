{% extends "base.html" %}
{% block title %}Admin Analytics{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-1">Sales & Analytics</h1>
    <div class="text-muted small">Last {{ data.days }} days · Saffron &amp; Smoke</div>
  </div>
  <a class="btn btn-outline-dark btn-sm" href="{{ url_for('admin.dashboard') }}">Back to Admin</a>
</div>

{% if not data.firestore_ok %}
  <div class="alert alert-warning shadow-sm">
    Firestore analytics unavailable right now. The dashboard will still show SQL order totals.
  </div>
{% endif %}

<div class="row g-3">
  <div class="col-md-4">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="text-muted small">Orders</div>
        <div class="fs-3 fw-semibold">{{ data.total_orders }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="text-muted small">Revenue</div>
        <div class="fs-3 fw-semibold">£{{ "%.2f"|format(data.revenue) }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="text-muted small">Avg order value</div>
        <div class="fs-3 fw-semibold">£{{ "%.2f"|format(data.avg_order_value) }}</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-lg-6">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h2 class="h6 mb-3">Conversion funnel (Firestore)</h2>

        <div class="mb-2">
          <div class="d-flex justify-content-between small">
            <span>Menu → Add to cart</span>
            <span>{{ "%.1f"|format(data.funnel.menu_to_cart) }}%</span>
          </div>
          <div class="progress" style="height: 10px;">
            <div class="progress-bar" role="progressbar" style="width: {{ data.funnel.menu_to_cart }}%"></div>
          </div>
        </div>

        <div class="mb-2">
          <div class="d-flex justify-content-between small">
            <span>Cart → Checkout</span>
            <span>{{ "%.1f"|format(data.funnel.cart_to_checkout) }}%</span>
          </div>
          <div class="progress" style="height: 10px;">
            <div class="progress-bar" role="progressbar" style="width: {{ data.funnel.cart_to_checkout }}%"></div>
          </div>
        </div>

        <div class="mb-2">
          <div class="d-flex justify-content-between small">
            <span>Checkout → Order placed</span>
            <span>{{ "%.1f"|format(data.funnel.checkout_to_order) }}%</span>
          </div>
          <div class="progress" style="height: 10px;">
            <div class="progress-bar" role="progressbar" style="width: {{ data.funnel.checkout_to_order }}%"></div>
          </div>
        </div>

        <hr>
        <div class="small text-muted">
          Overall Menu → Order: <strong>{{ "%.1f"|format(data.funnel.menu_to_order) }}%</strong>
          {% if data.peak_hour is not none %}
            · Peak activity hour: <strong>{{ data.peak_hour }}:00</strong>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h2 class="h6 mb-3">Top add-to-cart items (Firestore)</h2>

        {% if data.top_items %}
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
                <tr><th>Item</th><th class="text-end">Adds</th></tr>
              </thead>
              <tbody>
                {% for name, count in data.top_items %}
                  <tr>
                    <td class="fw-semibold">{{ name }}</td>
                    <td class="text-end">{{ count }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted">No add-to-cart events yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm border-0 mt-3">
  <div class="card-body">
    <h2 class="h6 mb-3">Recent orders (SQL)</h2>
    {% if data.recent_orders %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>#</th><th>Type</th><th>Status</th><th class="text-end">Total</th><th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for o in data.recent_orders %}
              <tr>
                <td class="fw-semibold">#{{ o.id }}</td>
                <td class="text-capitalize">{{ o.order_type }}</td>
                <td>{{ o.status.replace('_',' ') }}</td>
                <td class="text-end">£{{ "%.2f"|format(o.total_price) }}</td>
                <td class="text-muted small">{{ o.created_at }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">No orders in the last {{ data.days }} days.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
