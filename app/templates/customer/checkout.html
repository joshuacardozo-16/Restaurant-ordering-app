{% extends "base.html" %}
{% block title %}Checkout{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-lg-7">
    <div class="card shadow-sm border-0">
      <div class="card-body p-4 p-md-5">
        <h1 class="h4 mb-3">Checkout</h1>

        {# ‚úÖ SHOW FORM ERRORS (so delivery failures are visible) #}
        {% if form.errors %}
          <div class="alert alert-danger">
            <strong>Please fix the following:</strong>
            <ul class="mb-0">
              {% for field, errs in form.errors.items() %}
                {% for err in errs %}
                  <li><strong>{{ field }}</strong>: {{ err }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <form method="post">
          {{ form.hidden_tag() }}

          <div class="mb-3">
            <label class="form-label d-block">Order type</label>
            <div class="d-flex gap-3">
              {% for subfield in form.order_type %}
                <div class="form-check">
                  {{ subfield(class_="form-check-input") }}
                  {{ subfield.label(class_="form-check-label") }}
                </div>
              {% endfor %}
            </div>
          </div>

          <div id="delivery_fields">
            <h2 class="h6 mt-3">Delivery address</h2>

            <div class="mb-3">
              {{ form.delivery_address_line1.label(class_="form-label") }}
              {{ form.delivery_address_line1(class_="form-control") }}
            </div>

            <div class="mb-3">
              {{ form.delivery_address_line2.label(class_="form-label") }}
              {{ form.delivery_address_line2(class_="form-control") }}
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                {{ form.city.label(class_="form-label") }}
                {{ form.city(class_="form-control") }}
              </div>

              <div class="col-md-6">
                {{ form.postcode.label(class_="form-label") }}
                {# ensure postcode has an id so JS can find it #}
                {{ form.postcode(class_="form-control", id="postcode") }}
              </div>
            </div>

            {# ‚úÖ Live distance/ETA box (AJAX updates this) #}
            <div id="deliveryQuoteBox" class="alert alert-info mt-3 d-none"></div>
            <div id="deliveryBlockedBox" class="alert alert-danger mt-3 d-none"></div>

            {# ‚úÖ Keep backend-rendered info too (optional) #}
            {% if delivery_info %}
              <div class="alert alert-info mt-3 mb-0">
                üöó Distance:
                <strong>{{ "%.1f"|format(delivery_info.km if delivery_info.km is defined else delivery_info["km"]) }} km</strong>
                {% set eta = (delivery_info.eta if delivery_info.eta is defined else delivery_info.get("eta")) %}
                {% if eta %}
                  ‚Ä¢ ETA: <strong>{{ eta }}</strong>
                {% endif %}
              </div>
            {% endif %}

            {% if delivery_blocked %}
              <div class="alert alert-danger mt-3">
                ‚ùå Sorry ‚Äî this address is outside our delivery radius.
              </div>
            {% endif %}

            <div class="mt-3">
              {{ form.delivery_instructions.label(class_="form-label") }}
              {{ form.delivery_instructions(class_="form-control", rows="3") }}
            </div>
          </div>

          <div id="pickup_fields" class="mt-3">
            <h2 class="h6">Pickup</h2>
            <div class="mb-3">
              {{ form.pickup_time_requested.label(class_="form-label") }}
              {{ form.pickup_time_requested(class_="form-control", placeholder="e.g. 18:30") }}
              <div class="text-muted small mt-1">Pickup automatically applies a 15% discount.</div>
            </div>
          </div>

          <hr class="my-4">

          {# ‚úÖ hide payment fields if total is ¬£0.00 #}
          {% if total > 0 %}

            <h2 class="h6 mb-3">Payment (demo)</h2>
            <div class="row g-3">
              <div class="col-12">
                {{ form.cardholder_name.label(class_="form-label") }}
                {{ form.cardholder_name(class_="form-control", autocomplete="cc-name") }}
              </div>

              <div class="col-12">
                {{ form.card_number.label(class_="form-label") }}
                {{ form.card_number(
                    class_="form-control",
                    placeholder="1234 5678 9012 3456",
                    id="card_number",
                    inputmode="numeric",
                    maxlength="19",
                    autocomplete="cc-number"
                ) }}
                <div class="text-muted small mt-1">Demo only ‚Äî card details are not stored.</div>
              </div>

              <div class="col-md-6">
                {{ form.expiry.label(class_="form-label") }}
                {{ form.expiry(
                    class_="form-control",
                    placeholder="MM/YY",
                    id="expiry",
                    inputmode="numeric",
                    maxlength="5",
                    autocomplete="cc-exp"
                ) }}
              </div>

              <div class="col-md-6">
                {{ form.cvc.label(class_="form-label") }}
                {{ form.cvc(
                    class_="form-control",
                    placeholder="123",
                    id="cvc",
                    inputmode="numeric",
                    maxlength="4",
                    autocomplete="cc-csc"
                ) }}
              </div>
            </div>

          {% else %}

            <div class="alert alert-success mt-3">
              ‚úÖ Your total is ¬£0.00 ‚Äî no payment details required.
            </div>

          {% endif %}

          <div class="d-grid mt-4">
            {{ form.submit(class_="btn btn-dark btn-lg") }}
          </div>
        </form>

      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="position-sticky" style="top: 92px;">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <h2 class="h6 mb-3">Order summary</h2>

          <div class="list-group list-group-flush">
            {% for row in cart_rows %}
              <div class="list-group-item d-flex justify-content-between">
                <div>
                  <div class="fw-semibold">{{ row.item.name }}</div>
                  <div class="text-muted small">Qty: {{ row.qty }}</div>
                </div>
                {% if row.is_free %}
                  <div class="fw-semibold"><span class="badge text-bg-success">FREE</span> ¬£0.00</div>
                {% else %}
                  <div class="fw-semibold">¬£{{ "%.2f"|format(row.line_total) }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>

          <div class="mt-3">
            <div class="d-flex justify-content-between">
              <span class="text-muted">Subtotal</span>
              <span class="fw-semibold">¬£{{ "%.2f"|format(subtotal) }}</span>
            </div>

            {% if discount and discount > 0 %}
              <div class="d-flex justify-content-between">
                <span class="text-muted">{{ discount_label or "Discount" }}</span>
                <span class="fw-semibold">‚àí ¬£{{ "%.2f"|format(discount) }}</span>
              </div>
            {% endif %}

            {% if delivery_fee and delivery_fee > 0 %}
              <div class="d-flex justify-content-between">
                <span class="text-muted">Delivery fee</span>
                <span class="fw-semibold">+ ¬£{{ "%.2f"|format(delivery_fee) }}</span>
              </div>
            {% endif %}

            <hr>
            <div class="d-flex justify-content-between">
              <span class="fw-semibold">Total</span>
              <span class="fw-semibold">¬£{{ "%.2f"|format(total) }}</span>
            </div>

            <div class="text-muted small mt-2">
              Delivery requires Address line 1, City and Postcode. Pickup requires a pickup time.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleFields() {
    const selected = document.querySelector('input[name="order_type"]:checked')?.value;

    const deliveryFields = document.getElementById("delivery_fields");
    const pickupFields = document.getElementById("pickup_fields");

    const addr1 = document.getElementById("delivery_address_line1");
    const city = document.getElementById("city");
    const postcode = document.getElementById("postcode");
    const pickupTime = document.getElementById("pickup_time_requested");

    if (selected === "delivery") {
      deliveryFields.style.display = "block";
      pickupFields.style.display = "none";

      if (addr1) addr1.required = true;
      if (city) city.required = true;
      if (postcode) postcode.required = true;

      if (pickupTime) pickupTime.required = false;
    } else {
      deliveryFields.style.display = "none";
      pickupFields.style.display = "block";

      if (pickupTime) pickupTime.required = true;

      if (addr1) addr1.required = false;
      if (city) city.required = false;
      if (postcode) postcode.required = false;
    }
  }

  function formatCardNumber(value) {
    const digits = value.replace(/\D/g, "").slice(0, 16);
    return digits.replace(/(.{4})/g, "$1 ").trim();
  }

  function formatExpiry(value) {
    const digits = value.replace(/\D/g, "").slice(0, 4);
    if (digits.length <= 2) return digits;
    return digits.slice(0, 2) + "/" + digits.slice(2);
  }

  function debounce(fn, delay) {
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }

  async function fetchDeliveryQuote(postcode) {
    const quoteBox = document.getElementById("deliveryQuoteBox");
    const blockedBox = document.getElementById("deliveryBlockedBox");

    if (!quoteBox || !blockedBox) return;

    quoteBox.classList.add("d-none");
    blockedBox.classList.add("d-none");
    quoteBox.textContent = "";
    blockedBox.textContent = "";

    const selected = document.querySelector('input[name="order_type"]:checked')?.value;
    if (selected !== "delivery") return;

    if (!postcode || postcode.trim().length < 5) return;

    const url = new URL("{{ url_for('customer.delivery_quote') }}", window.location.origin);
    url.searchParams.set("postcode", postcode.trim());

    const resp = await fetch(url.toString(), { headers: { "Accept": "application/json" }});
    const data = await resp.json();

    if (!data.ok) {
      if (data.error === "missing_api_key") {
        quoteBox.textContent = "‚ö†Ô∏è Delivery quote unavailable (Google Maps API key missing).";
        quoteBox.classList.remove("d-none");
      }
      return;
    }

    const km = Number(data.distance_km).toFixed(1);
    const eta = data.eta ? ` ‚Ä¢ ETA: ${data.eta}` : "";
    quoteBox.innerHTML = `üöó Distance: <strong>${km} km</strong>${eta}`;
    quoteBox.classList.remove("d-none");

    if (data.blocked) {
      blockedBox.innerHTML = `‚ùå Outside our delivery radius (${data.max_km} km). Please choose Pickup.`;
      blockedBox.classList.remove("d-none");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    toggleFields();

    // keep your order_type refresh (pricing recalculation)
    document.querySelectorAll('input[name="order_type"]').forEach((el) => {
      el.addEventListener("change", () => {
        toggleFields();
        // keep your old behavior for order type changes:
        const baseUrl = "{{ url_for('customer.checkout') }}";
        const url = new URL(baseUrl, window.location.origin);
        url.searchParams.set("order_type", el.value);
        window.location.href = url.toString();
      });
    });

    // ‚úÖ postcode live fetch (NO REFRESH)
    const postcodeEl = document.getElementById("postcode");
    if (postcodeEl) {
      const run = debounce(() => fetchDeliveryQuote(postcodeEl.value), 600);
      postcodeEl.addEventListener("input", run);

      if (postcodeEl.value && postcodeEl.value.trim().length >= 5) {
        fetchDeliveryQuote(postcodeEl.value);
      }
    }

    const card = document.getElementById("card_number");
    const expiry = document.getElementById("expiry");
    const cvc = document.getElementById("cvc");

    if (card) {
      card.addEventListener("input", () => {
        card.value = formatCardNumber(card.value);
      });
    }

    if (expiry) {
      expiry.addEventListener("input", () => {
        expiry.value = formatExpiry(expiry.value);
      });
    }

    if (cvc) {
      cvc.addEventListener("input", () => {
        cvc.value = cvc.value.replace(/\D/g, "").slice(0, 4);
      });
    }
  });
</script>
{% endblock %}
