{% extends "base.html" %}
{% block title %}Menu{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-11">

    <!-- MENU HERO -->
    <div class="ss-hero p-4 p-md-5 shadow-sm mb-3">
      <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
        <div>
          <h1 class="h3 fw-bold mb-2">Menu</h1>
          <div class="ss-muted">
            Explore our favourites ‚Äî pickup gets <strong>15% off</strong>, and delivery is <strong>free over ¬£25</strong>.
          </div>

          <div class="d-flex flex-wrap gap-2 mt-3">
            <span class="ss-chip">üî• Popular items highlighted</span>
            <span class="ss-chip">‚≠ê Meal deals available</span>
            <span class="ss-chip">üöö Free delivery ¬£25+</span>
          </div>

          {% if popular_ids %}
            <div class="ss-muted small mt-2">
              Showing Popular based on real add-to-cart events.
            </div>
          {% endif %}
        </div>

        <form class="d-flex gap-2 flex-wrap" method="get" action="{{ url_for('customer.menu') }}">
          <input class="form-control" style="min-width: 220px;"
                 type="text" name="q" placeholder="Search dishes..." value="{{ q }}">
          <select class="form-select" name="category" style="min-width: 200px;">
            <option value="">All categories</option>
            {% for c in categories %}
              <option value="{{ c }}" {% if category==c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-ss" type="submit">Search</button>
          <a class="btn btn-outline-dark" href="{{ url_for('customer.menu') }}">Reset</a>
        </form>
      </div>
    </div>

    {# =========================
       Sticky category jump bar
       ========================= #}
    {% if categories %}
      <div class="ss-jumpbar">
        <div class="ss-jump-scroll">
          {% for c in categories %}
            <a href="#cat-{{ (c or 'other')|lower|replace(' ','-') }}">{{ c or "Other" }}</a>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {# =========================
       Recommended strip
       ========================= #}
    {% if menu_recs %}
      <div class="ss-recs-wrap">
        <div class="ss-recs-head">
          <h2 class="ss-recs-title">Recommended for you</h2>
          <span class="ss-sales-badge">Sales boost</span>
        </div>

        <div class="ss-recs">
          {% for r in menu_recs %}
            {% set img = r.image_url if r.image_url else url_for('static', filename='img/placeholder-food.jpg') %}

            <div class="ss-recs-card">
              <img src="{{ img }}" alt="{{ r.name }}">
              <div class="ss-recs-body">
                <div class="d-flex justify-content-between align-items-start gap-2">
                  <div class="ss-recs-name">{{ r.name }}</div>
                  <div class="ss-recs-price">¬£{{ "%.2f"|format(r.price) }}</div>
                </div>

                <div class="ss-recs-meta">{{ r.category }}</div>

                <div class="mt-2">
                  {% if current_user.is_authenticated %}
                    {% if (r.category or "")|lower in ["meal deals", "meal deal"] %}
                      <a class="btn btn-ss w-100 btn-sm" href="{{ url_for('customer.meal_deal_choose', deal_id=r.id) }}">
                        Build deal
                      </a>
                    {% else %}
                      <form method="post" action="{{ url_for('customer.cart_add', item_id=r.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="btn btn-ss w-100 btn-sm" type="submit">Add</button>
                      </form>
                    {% endif %}
                  {% else %}
                    <a class="btn btn-ss w-100 btn-sm" href="{{ url_for('auth.login') }}">Login to order</a>
                  {% endif %}
                </div>
              </div>
            </div>

          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if not items %}
      <div class="alert alert-light border shadow-sm rounded-4">
        No items found. Try clearing filters.
      </div>
    {% endif %}

    {# =========================
       Group items by category
       ========================= #}
    {% set ns = namespace(current_cat=None) %}

    {% for item in items %}
      {% if ns.current_cat != item.category %}
        {% if ns.current_cat is not none %}
          </div>  {# close row #}
          </div>  {# close section wrap #}
        {% endif %}

        {% set ns.current_cat = item.category %}

        <div class="ss-section-wrap">
          <div class="ss-section-title">
            <h2 id="cat-{{ (item.category or 'other')|lower|replace(' ','-') }}">
              {{ item.category or "Other" }}
            </h2>
            <div class="ss-divider"></div>
          </div>

          <div class="row g-3 mb-2">
      {% endif %}

      <div class="col-12 col-sm-6 col-lg-4 col-xl-3 d-flex">
        <div class="card ss-card ss-menu-card h-100 shadow-sm border-0 w-100">
          {% set img = item.image_url if item.image_url else url_for('static', filename='img/placeholder-food.jpg') %}
          <img class="ss-img" src="{{ img }}" alt="{{ item.name }}">

          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start gap-2 mb-1">
              <div class="fw-bold">{{ item.name }}</div>
              <div class="ss-price">¬£{{ "%.2f"|format(item.price) }}</div>
            </div>

            {# ===== Spice indicator (UI only heuristic) ===== #}
            {% set text = ((item.name or '') ~ ' ' ~ (item.description or ''))|lower %}
            {% set spice = 1 %}
            {% if 'vindaloo' in text or 'very hot' in text or 'extra hot' in text or 'naga' in text %}
              {% set spice = 3 %}
            {% elif 'hot' in text or 'spicy' in text or 'chilli' in text or 'chili' in text or 'madras' in text %}
              {% set spice = 2 %}
            {% endif %}

            <div class="ss-spice">
              <span class="label">Spice</span>
              <span class="dot {% if spice >= 1 %}on{% endif %}"></span>
              <span class="dot {% if spice >= 2 %}on{% endif %}"></span>
              <span class="dot {% if spice >= 3 %}on{% endif %}"></span>
            </div>

            {# Popular badge #}
            {% if popular_ids and item.id in popular_ids %}
              <div class="mb-2">
                <span class="ss-popular">üî• Popular</span>
              </div>
            {% else %}
              <div class="mb-2" style="height: 24px;"></div>
            {% endif %}

            {% if item.description %}
              <div class="text-muted small mb-3">{{ item.description }}</div>
            {% else %}
              <div class="text-muted small mb-3">Freshly prepared ‚Äî perfect with sides and a drink.</div>
            {% endif %}

            <div class="mt-auto">
              {% if current_user.is_authenticated %}
                {% if (item.category or '').lower() in ['meal deals', 'meal deal'] %}
                  <a class="btn btn-ss w-100"
                     href="{{ url_for('customer.meal_deal_choose', deal_id=item.id) }}">
                    Build your meal deal
                  </a>
                {% else %}
                  <form method="post" action="{{ url_for('customer.cart_add', item_id=item.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-ss w-100" type="submit">Add to cart</button>
                  </form>
                {% endif %}
              {% else %}
                <a class="btn btn-ss w-100" href="{{ url_for('auth.login') }}">Login to order</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

    {% endfor %}

    {% if items %}
        </div>  {# close final row #}
      </div>  {# close final section wrap #}
    {% endif %}
  </div>
</div>
{# ===== Mini Cart Chip (fixed bottom-right) ===== #}
{% set cart = session.get('cart', {}) %}
{% set cart_count = cart.values() | sum %}
{% if cart_count and cart_count > 0 %}
  <div class="ss-mini-cart">
    <span class="count">{{ cart_count }}</span>
    <span class="label">items in cart</span>
    <a href="{{ url_for('customer.cart_view') }}">View cart</a>
  </div>
{% endif %}
{% endblock %}
